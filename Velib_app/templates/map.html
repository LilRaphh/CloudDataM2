{% extends "base.html" %}
{% block title %}Carte des stations V√©lib'{% endblock %}
{% block content %}
<h1 class="page-title">Carte des stations V√©lib'</h1>

<form method="get" action="/map" style="margin-bottom:10px;">
    <label for="limit">Afficher :</label>
    <select name="limit" id="limit">
        {% for opt in [50,100,200,500,1000] %}
            <option value="{{ opt }}" {% if opt == limit %}selected{% endif %}>{{ opt }}</option>
        {% endfor %}
    </select>

    <label for="arr" style="margin-left:15px;">Arrondissement :</label>
    <select name="arr" id="arr">
        <option value="Tous">Tous</option>
        {% for a in arrondissements %}
            <option value="{{ a }}" {% if a == arrondissement %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
    </select>

    <button type="submit" style="margin-left:10px;">Filtrer</button>
</form>

<!-- Case ZFE -->
<div style="margin-bottom:10px;">
    <label>
        <input type="checkbox" id="toggle-zfe" />
        Afficher les zones ZFE (Zone √† Faibles √âmissions)
    </label>
</div>

<div id="map-container">
    <div id="sidebar">
        <input id="search" type="text" placeholder="Rechercher une station..." />
        <p id="station-count"><strong>Stations affich√©es :</strong> 0</p>

        <button id="sort-distance" style="margin-bottom:10px;">Trier par proximit√©</button>

        <ul id="results"></ul>

        <div id="summary">
            <h3>Indicateurs</h3>
            <p><strong>Total stations :</strong> <span id="total-stations">0</span></p>
            <p><strong>Total v√©los disponibles :</strong> <span id="total-bikes">0</span></p>
            <p><strong>Total bornes libres :</strong> <span id="total-docks">0</span></p>
        </div>
    </div>

    <div id="map"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script id="stations-data" type="application/json">
    {{ records | tojson }}
</script>

<script>
let USER_POSITION = null;
let currentRoute = null;
let zfeLayer = null;

// Couleur en fonction du nombre de v√©los dispo
function getBikeColor(nbBikes) {
    if (nbBikes === 0) return "#d73027";
    if (nbBikes <= 5) return "#fc8d59";
    if (nbBikes <= 10) return "#fee08b";
    return "#1a9850";
}

// Rayon du cercle en fonction du nombre de v√©los
function getBikeRadius(nbBikes) {
    if (nbBikes === 0) return 4;
    if (nbBikes <= 5) return 6;
    if (nbBikes <= 10) return 8;
    return 10;
}

const stations = JSON.parse(document.getElementById("stations-data").textContent);

const map = L.map('map').setView([48.8566, 2.3522], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
}).addTo(map);

function getCoords(s) {
    const c = s.coordonnees_geo;
    if (!c) return null;
    if (Array.isArray(c) && c.length === 2) return [c[0], c[1]];
    if (c.lat && c.lon) return [c.lat, c.lon];
    if (c.latitude && c.longitude) return [c.latitude, c.longitude];
    return null;
}

const markers = [];
stations.forEach(s => {
    const coords = getCoords(s);
    if (!coords) return;

    const nbBikes = Number(s.numbikesavailable) || 0;
    const color = getBikeColor(nbBikes);
    const radius = getBikeRadius(nbBikes);

    const marker = L.circleMarker(coords, {
        radius: radius,
        color: color,
        fillColor: color,
        fillOpacity: 0.9,
        weight: 1
    }).addTo(map);

    marker.bindPopup(`
        <b>${s.name || "Station"}</b><br>
        üö≤ V√©los : ${s.numbikesavailable ?? "?"}<br>
        üîå Bornes : ${s.numdocksavailable ?? "?"}<br>
        üìç ${s.nom_arrondissement_communes || "?"}
    `);

    markers.push({ station: s, marker });
});

function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dlat = (lat2 - lat1) * Math.PI / 180;
    const dlon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dlat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dlon / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

const resultsList = document.getElementById("results");
const searchInput = document.getElementById("search");

function updateResults(list) {
    resultsList.innerHTML = "";

    document.getElementById("station-count").innerHTML =
        `<strong>Stations affich√©es :</strong> ${list.length}`;

    let bikes = 0, docks = 0;

    list.forEach(s => {
        bikes += Number(s.numbikesavailable) || 0;
        docks += Number(s.numdocksavailable) || 0;
    });

    document.getElementById("total-stations").textContent = list.length;
    document.getElementById("total-bikes").textContent = bikes;
    document.getElementById("total-docks").textContent = docks;

    list.slice(0, 50).forEach(s => {
        const li = document.createElement("li");
        li.textContent = s.name || "Station";

        li.onclick = () => {
            const coords = getCoords(s);
            if (!coords) return;

            map.setView(coords, 16);

            const found = markers.find(m => m.station === s);
            if (found) found.marker.openPopup();

            drawRouteTo(coords[0], coords[1]);
        };

        resultsList.appendChild(li);
    });
}

searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase().trim();
    const filtered = q
        ? stations.filter(s => s.name && s.name.toLowerCase().includes(q))
        : stations;
    updateResults(filtered);
});

updateResults(stations);

document.getElementById("sort-distance").addEventListener("click", () => {
    if (!USER_POSITION) return alert("Position utilisateur inconnue.");

    const sorted = [...stations].map(s => {
        const coords = getCoords(s);
        if (!coords) return { ...s, distance: Infinity };

        const dist = haversine(USER_POSITION.lat, USER_POSITION.lon, coords[0], coords[1]);
        return { ...s, distance: dist };
    }).sort((a, b) => a.distance - b.distance);

    updateResults(sorted);
});

function drawRouteTo(lat, lon) {
    if (!USER_POSITION) return;

    if (currentRoute) map.removeControl(currentRoute);

    currentRoute = L.Routing.control({
        waypoints: [
            L.latLng(USER_POSITION.lat, USER_POSITION.lon),
            L.latLng(lat, lon)
        ],
        router: L.Routing.osrmv1({
            serviceUrl: "https://router.project-osrm.org/route/v1"
        }),
        createMarker: () => null,
        addWaypoints: false,
        fitSelectedRoutes: true,
        lineOptions: {
            styles: [{ color: "#555", weight: 5, opacity: 0.8 }]
        }
    }).addTo(map);
}

function locateUserAndRoute() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(async pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        USER_POSITION = { lat: userLat, lon: userLon };

        L.circleMarker([userLat, userLon], {
            radius: 10,
            color: "#007bff",
            fillColor: "#3399ff",
            fillOpacity: 0.8,
            weight: 3
        }).addTo(map).bindPopup("Vous √™tes ici");

        const res = await fetch(`/nearest_station?lat=${userLat}&lon=${userLon}`);
        const nearest = await res.json();

        drawRouteTo(nearest.lat, nearest.lon);
    });
}

function loadZFE() {
    fetch("/zfe_geojson")
        .then(res => {
            if (!res.ok) {
                console.error("Erreur chargement ZFE:", res.status);
                return null;
            }
            return res.json();
        })
        .then(data => {
            if (!data) return;

            zfeLayer = L.geoJSON(data, {
                style: {
                    color: "#800026",
                    weight: 2,
                    fillOpacity: 0.05
                }
            });

            const toggleZfe = document.getElementById("toggle-zfe");
            toggleZfe.disabled = false;

            toggleZfe.addEventListener("change", (e) => {
                if (e.target.checked) {
                    zfeLayer.addTo(map);
                    try {
                        map.fitBounds(zfeLayer.getBounds());
                    } catch (err) {
                        console.warn("fitBounds ZFE impossible:", err);
                    }
                } else {
                    map.removeLayer(zfeLayer);
                }
            });
        })
        .catch(err => console.error("Exception chargement ZFE:", err));
}

document.addEventListener("DOMContentLoaded", () => {
    locateUserAndRoute();
    loadZFE();
});
</script>

{% endblock %}
