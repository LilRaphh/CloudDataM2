{% extends "base.html" %}

{% block title %}Personnages - Stranger Graph{% endblock %}

{% block content %}
<section class="section-block">
    <h1>Personnages</h1>
    <p>
        Liste des personnages connus du graphe Neo4j.  
        Utilise la recherche et les filtres pour explorer Hawkins et le Monde à l'envers.
    </p>

    <!-- Filtres et recherche -->
    <div class="character-filters">
        <div class="filter-row">
            <div class="filter-col">
                <label for="char-search" class="filter-label">Recherche</label>
                <input
                    type="text"
                    id="char-search"
                    class="filter-input"
                    placeholder="Rechercher par nom (Eleven, Hopper, Vecna...)">
            </div>

            <div class="filter-col">
                <span class="filter-label">Catégorie</span>
                <div class="filter-chips">
                    <label><input type="checkbox" class="char-filter-category" value="Kid" checked> Kid</label>
                    <label><input type="checkbox" class="char-filter-category" value="Teen" checked> Teen</label>
                    <label><input type="checkbox" class="char-filter-category" value="Adult" checked> Adult</label>
                    <label><input type="checkbox" class="char-filter-category" value="Experiment" checked> Expérimenté</label>
                    <label><input type="checkbox" class="char-filter-category" value="Entity" checked> Entité</label>
                </div>
            </div>
        </div>

        <div class="filter-row">
            <div class="filter-col">
                <span class="filter-label">Statut</span>
                <div class="filter-chips">
                    <label><input type="checkbox" class="char-filter-status" value="Alive" checked> Alive</label>
                    <label><input type="checkbox" class="char-filter-status" value="Dead" checked> Dead</label>
                    <label><input type="checkbox" class="char-filter-status" value="Active" checked> Active</label>
                </div>
            </div>

            <div class="filter-col">
                <span class="filter-label">Rôle</span>
                <div class="filter-chips">
                    <label><input type="radio" name="char-filter-main" value="all" checked> Tous</label>
                    <label><input type="radio" name="char-filter-main" value="main"> Principaux</label>
                    <label><input type="radio" name="char-filter-main" value="side"> Récurrents</label>
                </div>
            </div>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="dark-table" id="characters-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Catégorie</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Saison d'introduction</th>
                    <th>Principal</th>
                </tr>
            </thead>
            <tbody>
                {% for c in characters %}
                <tr
                    class="character-row"
                    data-name="{{ c.name | lower }}"
                    data-category="{{ c.category }}"
                    data-type="{{ c.type }}"
                    data-status="{{ c.status }}"
                    data-main="{{ 'main' if c.is_main else 'side' }}"
                >
                    <td>{{ c.name }}</td>
                    <td>{{ c.category }}</td>
                    <td>{{ c.type }}</td>
                    <td>
                        <span class="status {{ c.status | lower }}">{{ c.status }}</span>
                    </td>
                    <td>{{ c.introduced_season }}</td>
                    <td>
                        {% if c.is_main %}
                            <span class="tag tag-main">Oui</span>
                        {% else %}
                            <span class="tag tag-side">Non</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <p id="characters-empty-message" class="empty-message" style="display:none;">
        Aucun personnage ne correspond à ces filtres.
    </p>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("char-search");
    const rows = Array.from(document.querySelectorAll("#characters-table .character-row"));
    const categoryBoxes = Array.from(document.querySelectorAll(".char-filter-category"));
    const statusBoxes = Array.from(document.querySelectorAll(".char-filter-status"));
    const mainRadios = Array.from(document.querySelectorAll("input[name='char-filter-main']"));
    const emptyMessage = document.getElementById("characters-empty-message");

    function getActiveCategories() {
        return categoryBoxes.filter(cb => cb.checked).map(cb => cb.value);
    }

    function getActiveStatuses() {
        return statusBoxes.filter(cb => cb.checked).map(cb => cb.value);
    }

    function getMainFilter() {
        const selected = mainRadios.find(r => r.checked);
        return selected ? selected.value : "all";
    }

    function applyFilters() {
        const search = searchInput.value.trim().toLowerCase();
        const activeCats = new Set(getActiveCategories());
        const activeStatuses = new Set(getActiveStatuses());
        const mainFilter = getMainFilter();

        let visibleCount = 0;

        rows.forEach(row => {
            const name = row.dataset.name || "";
            const cat = row.dataset.category || "";
            const status = row.dataset.status || "";
            const main = row.dataset.main || "side";

            let visible = true;

            // Recherche texte
            if (search && !name.includes(search)) {
                visible = false;
            }

            // Catégorie
            if (!activeCats.has(cat)) {
                visible = false;
            }

            // Statut
            if (!activeStatuses.has(status)) {
                visible = false;
            }

            // Rôle (principal / récurrent)
            if (mainFilter === "main" && main !== "main") {
                visible = false;
            } else if (mainFilter === "side" && main !== "side") {
                visible = false;
            }

            row.style.display = visible ? "" : "none";
            if (visible) visibleCount += 1;
        });

        emptyMessage.style.display = visibleCount === 0 ? "" : "none";
    }

    searchInput.addEventListener("input", applyFilters);
    categoryBoxes.forEach(cb => cb.addEventListener("change", applyFilters));
    statusBoxes.forEach(cb => cb.addEventListener("change", applyFilters));
    mainRadios.forEach(r => r.addEventListener("change", applyFilters));

    // Premier filtrage
    applyFilters();
});
</script>
{% endblock %}
